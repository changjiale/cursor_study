# sync.Map è¯¦è§£

## 1. åŸºç¡€æ¦‚å¿µ

### 1.1 ç»„ä»¶å®šä¹‰å’Œä½œç”¨
`sync.Map` æ˜¯ Go æ ‡å‡†åº“ä¸­æä¾›çš„ä¸€ç§å¹¶å‘å®‰å…¨çš„ map å®ç°ï¼Œä¸“é—¨ä¸ºä»¥ä¸‹åœºæ™¯ä¼˜åŒ–ï¼š
- è¯»å¤šå†™å°‘çš„åœºæ™¯
- é”®å€¼å¯¹åªå†™å…¥ä¸€æ¬¡ä½†è¯»å–å¤šæ¬¡
- å¤šä¸ª goroutine å¹¶å‘è¯»å–ï¼Œä½†å†™å…¥è¾ƒå°‘
- éœ€è¦é¿å…ä½¿ç”¨å¤–éƒ¨é”çš„åœºæ™¯

### 1.2 ä¸å…¶ä»–ç»„ä»¶çš„å¯¹æ¯”
- **vs map + mutex**ï¼šsync.Map é’ˆå¯¹è¯»å¤šå†™å°‘ä¼˜åŒ–ï¼Œæ€§èƒ½æ›´å¥½
- **vs map + RWMutex**ï¼šsync.Map æ— é”è¯»å–ï¼Œæ€§èƒ½æ›´ä¼˜
- **vs æ™®é€š map**ï¼šsync.Map æä¾›å¹¶å‘å®‰å…¨ï¼Œä½†æ€§èƒ½å¼€é”€æ›´å¤§

### 1.3 æ ¸å¿ƒç‰¹æ€§è¯´æ˜
- **å¹¶å‘å®‰å…¨**ï¼šæ”¯æŒå¤š goroutine å¹¶å‘è®¿é—®
- **è¯»å†™åˆ†ç¦»**ï¼šread å’Œ dirty åŒ map è®¾è®¡
- **æ— é”è¯»å–**ï¼šread map æ”¯æŒæ— é”å¹¶å‘è¯»å–
- **å»¶è¿Ÿåˆ é™¤**ï¼šåˆ é™¤æ“ä½œå»¶è¿Ÿåˆ° dirty æå‡æ—¶æ‰§è¡Œ

## 2. æ ¸å¿ƒæ•°æ®ç»“æ„

### 2.1 Map ç»“æ„ä½“ - é‡ç‚¹å­—æ®µè¯¦è§£

```go
type Map struct {
    // ğŸ”¥ å¹¶å‘æ§åˆ¶å­—æ®µ - é¢è¯•é‡ç‚¹
    mu Mutex // ä¿æŠ¤ dirty å­—æ®µçš„äº’æ–¥é”
    
    // ğŸ”¥ å†…å­˜ç®¡ç†å­—æ®µ - å†…å­˜ç®¡ç†é‡ç‚¹
    read atomic.Value // æŒ‡å‘ readOnly ç»“æ„ä½“
    
    // ğŸ”¥ æ€§èƒ½ä¼˜åŒ–å­—æ®µ - æ€§èƒ½ä¼˜åŒ–é‡ç‚¹
    dirty map[interface{}]*entry // åŒ…å«æ‰€æœ‰é”®å€¼å¯¹çš„ map
    
    // ğŸ”¥ å†…å­˜ç®¡ç†å­—æ®µ - å†…å­˜ç®¡ç†é‡ç‚¹
    misses int // ä» read ä¸­æœªæ‰¾åˆ°çš„æ¬¡æ•°
}
```

#### `read` - åªè¯» map
```go
// ä½œç”¨ï¼šå­˜å‚¨å¤§éƒ¨åˆ†é”®å€¼å¯¹ï¼Œæ”¯æŒæ— é”å¹¶å‘è¯»å–
// è®¾è®¡æ€æƒ³ï¼šè¯»å†™åˆ†ç¦»ï¼Œread map æ— é”è®¿é—®
// é¢è¯•é‡ç‚¹ï¼š
// 1. ä¸ºä»€ä¹ˆä½¿ç”¨ atomic.Valueï¼Ÿä¿è¯åŸå­æ€§è¯»å–
// 2. read map çš„ç‰¹ç‚¹ï¼Ÿåªè¯»ï¼Œæ— é”è®¿é—®ï¼Œæ€§èƒ½å¥½
// 3. read map çš„å†…å®¹ï¼ŸåŒ…å«å¤§éƒ¨åˆ†é”®å€¼å¯¹ï¼Œä½†ä¸åŒ…å«æ‰€æœ‰
```

#### `dirty` - å¯å†™ map
```go
// ä½œç”¨ï¼šåŒ…å«æ‰€æœ‰é”®å€¼å¯¹ï¼Œæ”¯æŒå†™å…¥æ“ä½œ
// è®¾è®¡æ€æƒ³ï¼šå†™å…¥æ“ä½œé›†ä¸­åœ¨ dirty map
// é¢è¯•é‡ç‚¹ï¼š
// 1. dirty map çš„ç‰¹ç‚¹ï¼ŸåŒ…å«æ‰€æœ‰é”®å€¼å¯¹ï¼Œéœ€è¦åŠ é”è®¿é—®
// 2. dirty map çš„ä½œç”¨ï¼Ÿå¤„ç†å†™å…¥å’Œåˆ é™¤æ“ä½œ
// 3. æå‡æœºåˆ¶ï¼Ÿå½“ misses è¾¾åˆ°é˜ˆå€¼æ—¶ï¼Œdirty æå‡ä¸º read
```

#### `mu` - äº’æ–¥é”
```go
// ä½œç”¨ï¼šä¿æŠ¤ dirty å­—æ®µçš„è®¿é—®
// è®¾è®¡æ€æƒ³ï¼šåªåœ¨å¿…è¦æ—¶åŠ é”ï¼Œå‡å°‘é”ç«äº‰
// é¢è¯•é‡ç‚¹ï¼š
// 1. é”çš„ä½œç”¨èŒƒå›´ï¼Ÿåªä¿æŠ¤ dirty å­—æ®µ
// 2. é”çš„ç²’åº¦ï¼Ÿç»†ç²’åº¦é”ï¼Œå‡å°‘ç«äº‰
// 3. æ€§èƒ½ä¼˜åŒ–ï¼Ÿread æ“ä½œæ— é”ï¼Œåªæœ‰ dirty æ“ä½œéœ€è¦é”
```

#### `misses` - æœªå‘½ä¸­è®¡æ•°
```go
// ä½œç”¨ï¼šè®°å½•ä» read ä¸­æœªæ‰¾åˆ°é”®çš„æ¬¡æ•°
// è®¾è®¡æ€æƒ³ï¼šç”¨äºè§¦å‘ dirty æå‡æœºåˆ¶
// é¢è¯•é‡ç‚¹ï¼š
// 1. misses çš„ä½œç”¨ï¼Ÿè§¦å‘ dirty æå‡çš„é˜ˆå€¼
// 2. æå‡æ¡ä»¶ï¼Ÿmisses >= len(dirty)
// 3. é‡ç½®æœºåˆ¶ï¼Ÿæå‡å misses é‡ç½®ä¸º 0
```

### 2.2 readOnly ç»“æ„ä½“ - åªè¯»ç»“æ„

```go
type readOnly struct {
    // ğŸ”¥ å†…å­˜ç®¡ç†å­—æ®µ - å†…å­˜ç®¡ç†é‡ç‚¹
    m       map[interface{}]*entry // åªè¯»çš„é”®å€¼å¯¹ map
    amended bool                   // æ˜¯å¦æœ‰é”®åœ¨ dirty ä¸­ä½†ä¸åœ¨ read ä¸­
}
```

#### `m` - åªè¯» map
```go
// ä½œç”¨ï¼šå­˜å‚¨é”®å€¼å¯¹ï¼Œæ”¯æŒæ— é”è¯»å–
// è®¾è®¡æ€æƒ³ï¼šåªè¯»è®¾è®¡ï¼Œé¿å…å¹¶å‘ä¿®æ”¹
// é¢è¯•é‡ç‚¹ï¼š
// 1. æ— é”è¯»å–ï¼šæ”¯æŒå¤šä¸ª goroutine å¹¶å‘è¯»å–
// 2. å†…å®¹é™åˆ¶ï¼šåªåŒ…å«éƒ¨åˆ†é”®å€¼å¯¹
// 3. æ€§èƒ½ä¼˜åŠ¿ï¼šæ— é”è®¿é—®ï¼Œæ€§èƒ½æœ€å¥½
```

#### `amended` - ä¿®æ”¹æ ‡å¿—
```go
// ä½œç”¨ï¼šæ ‡è®°æ˜¯å¦æœ‰é”®åœ¨ dirty ä¸­ä½†ä¸åœ¨ read ä¸­
// è®¾è®¡æ€æƒ³ï¼šä¼˜åŒ–æŸ¥æ‰¾æ€§èƒ½ï¼Œé¿å…ä¸å¿…è¦çš„ dirty æŸ¥æ‰¾
// é¢è¯•é‡ç‚¹ï¼š
// 1. amended çš„ä½œç”¨ï¼Ÿå¿«é€Ÿåˆ¤æ–­æ˜¯å¦éœ€è¦æŸ¥æ‰¾ dirty
// 2. æ€§èƒ½ä¼˜åŒ–ï¼šé¿å…ä¸å¿…è¦çš„ dirty è®¿é—®
// 3. ä¸€è‡´æ€§ä¿è¯ï¼šç¡®ä¿æŸ¥æ‰¾çš„å®Œæ•´æ€§
```

### 2.3 entry ç»“æ„ä½“ - å€¼å­˜å‚¨ç»“æ„

```go
type entry struct {
    // ğŸ”¥ å†…å­˜ç®¡ç†å­—æ®µ - å†…å­˜ç®¡ç†é‡ç‚¹
    p unsafe.Pointer // æŒ‡å‘å®é™…å€¼çš„æŒ‡é’ˆ
}
```

#### `p` - å€¼æŒ‡é’ˆ
```go
// ä½œç”¨ï¼šå­˜å‚¨å®é™…çš„å€¼æˆ–ç‰¹æ®Šæ ‡è®°
// è®¾è®¡æ€æƒ³ï¼šä½¿ç”¨æŒ‡é’ˆå­˜å‚¨ï¼Œæ”¯æŒåŸå­æ“ä½œ
// é¢è¯•é‡ç‚¹ï¼š
// 1. ç‰¹æ®Šå€¼ï¼šnil è¡¨ç¤ºå·²åˆ é™¤ï¼Œexpunged è¡¨ç¤ºå·²æ¸…ç†
// 2. åŸå­æ“ä½œï¼šæ”¯æŒåŸå­æ€§çš„å€¼æ›´æ–°
// 3. å†…å­˜ç®¡ç†ï¼šé¿å…å†…å­˜æ³„æ¼
```

## 3. é‡ç‚¹å­—æ®µæ·±åº¦è§£æ

### 3.1 ğŸ”¥ è¯»å†™åˆ†ç¦»å­—æ®µ

#### `read` - æ— é”è¯»å–è®¾è®¡
```go
// ä½œç”¨ï¼šå®ç°æ— é”å¹¶å‘è¯»å–
// è®¾è®¡æ€æƒ³ï¼šatomic.Value ä¿è¯åŸå­æ€§ï¼ŒreadOnly ä¿è¯åªè¯»
// é¢è¯•é‡ç‚¹ï¼š
// 1. åŸå­æ€§ä¿è¯ï¼šatomic.Value.Load() æä¾›åŸå­æ€§è¯»å–
// 2. åªè¯»ä¿è¯ï¼šreadOnly ç»“æ„ä½“ä¸å¯ä¿®æ”¹
// 3. æ€§èƒ½ä¼˜åŠ¿ï¼šæ— é”è¯»å–ï¼Œæ€§èƒ½æœ€å¥½
```

#### `dirty` - å†™å…¥é›†ä¸­è®¾è®¡
```go
// ä½œç”¨ï¼šé›†ä¸­å¤„ç†æ‰€æœ‰å†™å…¥æ“ä½œ
// è®¾è®¡æ€æƒ³ï¼šå†™å…¥æ“ä½œéœ€è¦åŠ é”ï¼Œé›†ä¸­åœ¨ dirty map
// é¢è¯•é‡ç‚¹ï¼š
// 1. é”ä¿æŠ¤ï¼šæ‰€æœ‰ dirty æ“ä½œéƒ½éœ€è¦ mu é”ä¿æŠ¤
// 2. å®Œæ•´æ€§ï¼šdirty åŒ…å«æ‰€æœ‰é”®å€¼å¯¹
// 3. æ€§èƒ½è€ƒè™‘ï¼šå†™å…¥æ“ä½œç›¸å¯¹è¾ƒå°‘
```

### 3.2 ğŸ”¥ æ€§èƒ½ä¼˜åŒ–å­—æ®µ

#### `misses` - æå‡è§¦å‘æœºåˆ¶
```go
// ä½œç”¨ï¼šè§¦å‘ dirty æå‡ä¸º read çš„æœºåˆ¶
// è®¾è®¡æ€æƒ³ï¼šåŸºäºæœªå‘½ä¸­æ¬¡æ•°åŠ¨æ€è°ƒæ•´
// é¢è¯•é‡ç‚¹ï¼š
// 1. é˜ˆå€¼è®¾ç½®ï¼šmisses >= len(dirty) æ—¶è§¦å‘æå‡
// 2. åŠ¨æ€è°ƒæ•´ï¼šæ ¹æ®è®¿é—®æ¨¡å¼è‡ªåŠ¨è°ƒæ•´
// 3. æ€§èƒ½ä¼˜åŒ–ï¼šå‡å°‘ missesï¼Œæé«˜ read å‘½ä¸­ç‡
```

## 4. æ ¸å¿ƒæœºåˆ¶è¯¦è§£

### 4.1 è¯»å†™åˆ†ç¦»æœºåˆ¶

#### 4.1.1 è¯»å–æµç¨‹
```go
func (m *Map) Load(key interface{}) (value interface{}, ok bool) {
    read, _ := m.read.Load().(readOnly)
    e, ok := read.m[key]
    if !ok && read.amended {
        m.mu.Lock()
        read, _ = m.read.Load().(readOnly)
        e, ok = read.m[key]
        if !ok && read.amended {
            e, ok = m.dirty[key]
            m.missLocked()
        }
        m.mu.Unlock()
    }
    if !ok {
        return nil, false
    }
    return e.load()
}
```

#### 4.1.2 å†™å…¥æµç¨‹
```go
func (m *Map) Store(key, value interface{}) {
    read, _ := m.read.Load().(readOnly)
    if e, ok := read.m[key]; ok && e.tryStore(&value) {
        return // å¿«é€Ÿè·¯å¾„ï¼šç›´æ¥æ›´æ–° read ä¸­çš„å€¼
    }
    
    m.mu.Lock()
    defer m.mu.Unlock()
    read, _ = m.read.Load().(readOnly)
    if e, ok := read.m[key]; ok {
        if e.unexpungeLocked() {
            m.dirty[key] = e
        }
        e.storeLocked(&value)
    } else if e, ok := m.dirty[key]; ok {
        e.storeLocked(&value)
    } else {
        if !read.amended {
            m.dirtyLocked()
            read.amended = true
        }
        m.dirty[key] = newEntry(value)
    }
}
```

### 4.2 å»¶è¿Ÿåˆ é™¤æœºåˆ¶

#### 4.2.1 åˆ é™¤æµç¨‹
```go
func (m *Map) Delete(key interface{}) {
    read, _ := m.read.Load().(readOnly)
    e, ok := read.m[key]
    if !ok && read.amended {
        m.mu.Lock()
        read, _ = m.read.Load().(readOnly)
        e, ok = read.m[key]
        if !ok && read.amended {
            delete(m.dirty, key)
        }
        m.mu.Unlock()
    }
    if ok {
        e.delete()
    }
}
```

#### 4.2.2 å»¶è¿Ÿåˆ é™¤åŸç†
- **æ ‡è®°åˆ é™¤**ï¼šåœ¨ read ä¸­æ ‡è®°ä¸º nilï¼Œä¸ç«‹å³åˆ é™¤
- **å®é™…åˆ é™¤**ï¼šåœ¨ dirty æå‡æ—¶æ¸…ç†æ ‡è®°çš„æ¡ç›®
- **æ€§èƒ½ä¼˜åŒ–**ï¼šé¿å…é¢‘ç¹çš„ map é‡å»º

### 4.3 æå‡æœºåˆ¶

#### 4.3.1 æå‡è§¦å‘æ¡ä»¶
```go
func (m *Map) missLocked() {
    m.misses++
    if m.misses < len(m.dirty) {
        return
    }
    m.read.Store(readOnly{m: m.dirty})
    m.dirty = nil
    m.misses = 0
}
```

#### 4.3.2 æå‡è¿‡ç¨‹
1. **æ£€æŸ¥æ¡ä»¶**ï¼šmisses >= len(dirty)
2. **äº¤æ¢æ•°æ®**ï¼šå°† dirty æå‡ä¸º read
3. **æ¸…ç† dirty**ï¼šdirty è®¾ä¸º nil
4. **é‡ç½® misses**ï¼šmisses é‡ç½®ä¸º 0

## 5. é¢è¯•è€ƒå¯Ÿç‚¹

### 5.1 åŸºç¡€æ¦‚å¿µé¢˜
**Q: sync.Map çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ**
- **ç®€ç­”**ï¼šæä¾›å¹¶å‘å®‰å…¨çš„ map å®ç°ï¼Œé’ˆå¯¹è¯»å¤šå†™å°‘åœºæ™¯ä¼˜åŒ–
- **å…·ä½“åˆ†æ**ï¼šè¯¦è§ **1.1 ç»„ä»¶å®šä¹‰å’Œä½œç”¨** ç« èŠ‚

**Q: sync.Map vs map + mutex çš„å¯¹æ¯”ï¼Ÿ**
- **ç®€ç­”**ï¼šsync.Map è¯»å¤šå†™å°‘åœºæ™¯æ€§èƒ½æ›´å¥½ï¼Œmap + mutex æ›´é€šç”¨
- **å…·ä½“åˆ†æ**ï¼šè¯¦è§ **1.2 ä¸å…¶ä»–ç»„ä»¶çš„å¯¹æ¯”** ç« èŠ‚

### 5.2 æ ¸å¿ƒæœºåˆ¶ç›¸å…³
**Q: sync.Map çš„è¯»å†™åˆ†ç¦»æœºåˆ¶ï¼Ÿ**
- **ç®€ç­”**ï¼šread æ— é”è¯»å–ï¼Œdirty åŠ é”å†™å…¥ï¼ŒåŒ map è®¾è®¡
- **å…·ä½“åˆ†æ**ï¼šè¯¦è§ **4.1 è¯»å†™åˆ†ç¦»æœºåˆ¶** ç« èŠ‚

**Q: å»¶è¿Ÿåˆ é™¤æœºåˆ¶çš„ä½œç”¨ï¼Ÿ**
- **ç®€ç­”**ï¼šé¿å…é¢‘ç¹ map é‡å»ºï¼Œæé«˜æ€§èƒ½
- **å…·ä½“åˆ†æ**ï¼šè¯¦è§ **4.2 å»¶è¿Ÿåˆ é™¤æœºåˆ¶** ç« èŠ‚

### 5.3 å†…å­˜ç®¡ç†ç›¸å…³
**Q: sync.Map çš„å†…å­˜å¸ƒå±€ï¼Ÿ**
- **ç®€ç­”**ï¼šread å’Œ dirty åŒ mapï¼Œentry æŒ‡é’ˆå­˜å‚¨
- **å…·ä½“åˆ†æ**ï¼šè¯¦è§ **2.1 Map ç»“æ„ä½“ - é‡ç‚¹å­—æ®µè¯¦è§£** ç« èŠ‚

**Q: sync.Map ä¼šå¯¼è‡´å†…å­˜æ³„æ¼å—ï¼Ÿ**
- **ç®€ç­”**ï¼šä¸ä¼šï¼Œæœ‰å»¶è¿Ÿåˆ é™¤å’Œæå‡æœºåˆ¶
- **å…·ä½“åˆ†æ**ï¼šè¯¦è§ **4.2 å»¶è¿Ÿåˆ é™¤æœºåˆ¶** ç« èŠ‚

### 5.4 å¹¶å‘æ§åˆ¶ç›¸å…³
**Q: sync.Map çš„å¹¶å‘å®‰å…¨æ€§ï¼Ÿ**
- **ç®€ç­”**ï¼šread æ— é”è¯»å–ï¼Œdirty åŠ é”å†™å…¥ï¼Œå®Œå…¨å¹¶å‘å®‰å…¨
- **å…·ä½“åˆ†æ**ï¼šè¯¦è§ **4.1 è¯»å†™åˆ†ç¦»æœºåˆ¶** ç« èŠ‚

**Q: æå‡æœºåˆ¶çš„ä½œç”¨ï¼Ÿ**
- **ç®€ç­”**ï¼šåŠ¨æ€è°ƒæ•´ read å’Œ dirtyï¼Œä¼˜åŒ–æ€§èƒ½
- **å…·ä½“åˆ†æ**ï¼šè¯¦è§ **4.3 æå‡æœºåˆ¶** ç« èŠ‚

### 5.5 æ€§èƒ½ä¼˜åŒ–ç›¸å…³
**Q: sync.Map çš„æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼Ÿ**
- **ç®€ç­”**ï¼šè¯»å†™åˆ†ç¦»ï¼Œæ— é”è¯»å–ï¼Œå»¶è¿Ÿåˆ é™¤ï¼ŒåŠ¨æ€æå‡
- **å…·ä½“åˆ†æ**ï¼šè¯¦è§ **4.1 è¯»å†™åˆ†ç¦»æœºåˆ¶** ç« èŠ‚

**Q: ä½•æ—¶ä½¿ç”¨ sync.Mapï¼Ÿ**
- **ç®€ç­”**ï¼šè¯»å¤šå†™å°‘ï¼Œé”®å€¼å¯¹å†™å…¥ä¸€æ¬¡è¯»å–å¤šæ¬¡çš„åœºæ™¯
- **å…·ä½“åˆ†æ**ï¼šè¯¦è§ **6.1 åŸºç¡€åº”ç”¨** ç« èŠ‚

### 5.6 å®é™…é—®é¢˜
**Q: sync.Map çš„é€‚ç”¨åœºæ™¯ï¼Ÿ**
- **ç®€ç­”**ï¼šç¼“å­˜ã€é…ç½®ç®¡ç†ã€è¯»å¤šå†™å°‘çš„æ•°æ®ç»“æ„
- **å…·ä½“åˆ†æ**ï¼šè¯¦è§ **6.1 åŸºç¡€åº”ç”¨** ç« èŠ‚

**Q: å¦‚ä½•æ­£ç¡®ä½¿ç”¨ sync.Mapï¼Ÿ**
- **ç®€ç­”**ï¼šç†è§£è¯»å†™åˆ†ç¦»ï¼Œé¿å…é¢‘ç¹å†™å…¥ï¼Œåˆç†ä½¿ç”¨åœºæ™¯
- **å…·ä½“åˆ†æ**ï¼šè¯¦è§ **6.2 é«˜çº§åº”ç”¨** ç« èŠ‚

## 6. å®é™…åº”ç”¨åœºæ™¯

### 6.1 åŸºç¡€åº”ç”¨
```go
// ç¼“å­˜å®ç°
type Cache struct {
    data sync.Map
}

func (c *Cache) Get(key string) (interface{}, bool) {
    return c.data.Load(key)
}

func (c *Cache) Set(key string, value interface{}) {
    c.data.Store(key, value)
}

func (c *Cache) Delete(key string) {
    c.data.Delete(key)
}

// ä½¿ç”¨ç¤ºä¾‹
func main() {
    cache := &Cache{}
    
    // å¹¶å‘è¯»å–
    for i := 0; i < 10; i++ {
        go func(id int) {
            for j := 0; j < 1000; j++ {
                cache.Get(fmt.Sprintf("key-%d", j))
            }
        }(i)
    }
    
    // å†™å…¥æ“ä½œ
    cache.Set("key-1", "value-1")
    cache.Set("key-2", "value-2")
    
    time.Sleep(time.Second)
}
```

### 6.2 é«˜çº§åº”ç”¨
```go
// é…ç½®ç®¡ç†
type ConfigManager struct {
    config sync.Map
    once   sync.Once
}

func (cm *ConfigManager) LoadConfig() {
    cm.once.Do(func() {
        // åŠ è½½é…ç½®
        cm.config.Store("host", "localhost")
        cm.config.Store("port", 8080)
        cm.config.Store("timeout", 30)
    })
}

func (cm *ConfigManager) Get(key string) interface{} {
    cm.LoadConfig()
    value, _ := cm.config.Load(key)
    return value
}

func (cm *ConfigManager) Set(key string, value interface{}) {
    cm.config.Store(key, value)
}
```

### 6.3 æ€§èƒ½ä¼˜åŒ–
```go
// å¯¹è±¡æ± ç®¡ç†
type ObjectPool struct {
    pool sync.Map
}

func (op *ObjectPool) Get(key string) interface{} {
    if obj, ok := op.pool.Load(key); ok {
        return obj
    }
    return nil
}

func (op *ObjectPool) Put(key string, obj interface{}) {
    op.pool.Store(key, obj)
}

func (op *ObjectPool) Remove(key string) {
    op.pool.Delete(key)
}
```

### 6.4 è°ƒè¯•åˆ†æ
```go
// sync.Map æ€§èƒ½åˆ†æ
func analyzeSyncMapPerformance() {
    var syncMap sync.Map
    var mutexMap = struct {
        sync.RWMutex
        data map[string]interface{}
    }{
        data: make(map[string]interface{}),
    }
    
    // æµ‹è¯• sync.Map å†™å…¥æ€§èƒ½
    start := time.Now()
    for i := 0; i < 10000; i++ {
        syncMap.Store(fmt.Sprintf("key-%d", i), i)
    }
    syncMapWrite := time.Since(start)
    
    // æµ‹è¯• mutex map å†™å…¥æ€§èƒ½
    start = time.Now()
    for i := 0; i < 10000; i++ {
        mutexMap.Lock()
        mutexMap.data[fmt.Sprintf("key-%d", i)] = i
        mutexMap.Unlock()
    }
    mutexMapWrite := time.Since(start)
    
    // æµ‹è¯•è¯»å–æ€§èƒ½
    start = time.Now()
    for i := 0; i < 100000; i++ {
        syncMap.Load(fmt.Sprintf("key-%d", i%10000))
    }
    syncMapRead := time.Since(start)
    
    start = time.Now()
    for i := 0; i < 100000; i++ {
        mutexMap.RLock()
        _ = mutexMap.data[fmt.Sprintf("key-%d", i%10000)]
        mutexMap.RUnlock()
    }
    mutexMapRead := time.Since(start)
    
    fmt.Printf("Sync.Map write: %v\n", syncMapWrite)
    fmt.Printf("Mutex map write: %v\n", mutexMapWrite)
    fmt.Printf("Sync.Map read: %v\n", syncMapRead)
    fmt.Printf("Mutex map read: %v\n", mutexMapRead)
}
```

## 7. æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 7.1 æ ¸å¿ƒä¼˜åŒ–
- **åˆç†ä½¿ç”¨åœºæ™¯**ï¼šåªåœ¨è¯»å¤šå†™å°‘åœºæ™¯ä½¿ç”¨ sync.Map
- **é¿å…é¢‘ç¹å†™å…¥**ï¼šå†™å…¥æ“ä½œä¼šè§¦å‘é”ç«äº‰
- **ç†è§£æå‡æœºåˆ¶**ï¼šmisses è¿‡å¤šä¼šå½±å“æ€§èƒ½
- **åˆç†è®¾è®¡é”®å€¼**ï¼šé¿å…å¤§å¯¹è±¡ä½œä¸ºé”®å€¼

### 7.2 å†…å­˜ä¼˜åŒ–
- **åŠæ—¶åˆ é™¤**ï¼šä¸éœ€è¦çš„é”®å€¼å¯¹åŠæ—¶åˆ é™¤
- **é¿å…å†…å­˜æ³„æ¼**ï¼šæ³¨æ„ entry çš„ç‰¹æ®Šå€¼å¤„ç†
- **ç›‘æ§å†…å­˜ä½¿ç”¨**ï¼šç›‘æ§ sync.Map çš„å†…å­˜ä½¿ç”¨æƒ…å†µ

### 7.3 å¹¶å‘ä¼˜åŒ–
- **å‡å°‘é”ç«äº‰**ï¼šé¿å…é¢‘ç¹çš„å†™å…¥æ“ä½œ
- **æ‰¹é‡æ“ä½œ**ï¼šæ‰¹é‡å¤„ç†ä¼˜äºé€ä¸ªå¤„ç†
- **é¢„çƒ­ç­–ç•¥**ï¼šåœ¨ç¨‹åºå¯åŠ¨æ—¶é¢„çƒ­ sync.Map

## 8. é¢è¯•è€ƒå¯Ÿæ±‡æ€»

### ğŸ“‹ æ ¸å¿ƒçŸ¥è¯†ç‚¹æ¸…å•

#### ğŸ”¥ å¿…è€ƒçŸ¥è¯†ç‚¹
**1. sync.Map çš„è®¾è®¡æ€æƒ³**
- **ç®€ç­”**ï¼šè¯»å†™åˆ†ç¦»ï¼ŒåŒ map è®¾è®¡ï¼Œæ— é”è¯»å–ï¼Œå»¶è¿Ÿåˆ é™¤
- **å…·ä½“åˆ†æ**ï¼šè¯¦è§ **1.1 ç»„ä»¶å®šä¹‰å’Œä½œç”¨** ç« èŠ‚

**2. è¯»å†™åˆ†ç¦»æœºåˆ¶**
- **ç®€ç­”**ï¼šread æ— é”è¯»å–ï¼Œdirty åŠ é”å†™å…¥ï¼ŒåŒ map è®¾è®¡
- **å…·ä½“åˆ†æ**ï¼šè¯¦è§ **4.1 è¯»å†™åˆ†ç¦»æœºåˆ¶** ç« èŠ‚

**3. å»¶è¿Ÿåˆ é™¤æœºåˆ¶**
- **ç®€ç­”**ï¼šæ ‡è®°åˆ é™¤ï¼Œå»¶è¿Ÿæ¸…ç†ï¼Œé¿å…é¢‘ç¹ map é‡å»º
- **å…·ä½“åˆ†æ**ï¼šè¯¦è§ **4.2 å»¶è¿Ÿåˆ é™¤æœºåˆ¶** ç« èŠ‚

#### ğŸ”¥ é«˜é¢‘è€ƒç‚¹
**1. sync.Map vs map + mutex**
- **ç®€ç­”**ï¼šsync.Map è¯»å¤šå†™å°‘åœºæ™¯æ€§èƒ½æ›´å¥½ï¼Œmap + mutex æ›´é€šç”¨
- **å…·ä½“åˆ†æ**ï¼šè¯¦è§ **1.2 ä¸å…¶ä»–ç»„ä»¶çš„å¯¹æ¯”** ç« èŠ‚

**2. æå‡æœºåˆ¶**
- **ç®€ç­”**ï¼šåŸºäº misses åŠ¨æ€è°ƒæ•´ï¼Œä¼˜åŒ–æ€§èƒ½
- **å…·ä½“åˆ†æ**ï¼šè¯¦è§ **4.3 æå‡æœºåˆ¶** ç« èŠ‚

**3. é€‚ç”¨åœºæ™¯**
- **ç®€ç­”**ï¼šè¯»å¤šå†™å°‘ï¼Œé”®å€¼å¯¹å†™å…¥ä¸€æ¬¡è¯»å–å¤šæ¬¡
- **å…·ä½“åˆ†æ**ï¼šè¯¦è§ **6.1 åŸºç¡€åº”ç”¨** ç« èŠ‚

#### ğŸ”¥ å®é™…é—®é¢˜
**1. å¦‚ä½•æ­£ç¡®ä½¿ç”¨ sync.Mapï¼Ÿ**
- **ç®€ç­”**ï¼šç†è§£è¯»å†™åˆ†ç¦»ï¼Œé¿å…é¢‘ç¹å†™å…¥ï¼Œåˆç†ä½¿ç”¨åœºæ™¯
- **å…·ä½“åˆ†æ**ï¼šè¯¦è§ **6.2 é«˜çº§åº”ç”¨** ç« èŠ‚

**2. sync.Map çš„æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**
- **ç®€ç­”**ï¼šè¯»å†™åˆ†ç¦»ï¼Œæ— é”è¯»å–ï¼Œå»¶è¿Ÿåˆ é™¤ï¼ŒåŠ¨æ€æå‡
- **å…·ä½“åˆ†æ**ï¼šè¯¦è§ **7.1 æ ¸å¿ƒä¼˜åŒ–** ç« èŠ‚

### ğŸ¯ é¢è¯•é‡ç‚¹æé†’

#### å¿…é¡»æŒæ¡çš„æ ¸å¿ƒå­—æ®µ
- **read**ï¼šåªè¯» mapï¼Œæ”¯æŒæ— é”è¯»å–
- **dirty**ï¼šå¯å†™ mapï¼Œéœ€è¦åŠ é”è®¿é—®
- **mu**ï¼šäº’æ–¥é”ï¼Œä¿æŠ¤ dirty å­—æ®µ
- **misses**ï¼šæœªå‘½ä¸­è®¡æ•°ï¼Œè§¦å‘æå‡æœºåˆ¶

#### å¿…é¡»ç†è§£çš„è®¾è®¡æ€æƒ³
- **è¯»å†™åˆ†ç¦»**ï¼šread æ— é”ï¼Œdirty åŠ é”
- **åŒ map è®¾è®¡**ï¼šread å’Œ dirty åˆ†ç¦»
- **å»¶è¿Ÿåˆ é™¤**ï¼šæ ‡è®°åˆ é™¤ï¼Œå»¶è¿Ÿæ¸…ç†
- **åŠ¨æ€æå‡**ï¼šåŸºäº misses è°ƒæ•´

#### å¿…é¡»å‡†å¤‡çš„å®é™…æ¡ˆä¾‹
- **ç¼“å­˜å®ç°**ï¼šè¯»å¤šå†™å°‘çš„ç¼“å­˜
- **é…ç½®ç®¡ç†**ï¼šé…ç½®çš„å¹¶å‘è®¿é—®
- **å¯¹è±¡æ± **ï¼šå¯¹è±¡æ± çš„ç®¡ç†
- **æ€§èƒ½åˆ†æ**ï¼šsync.Map vs å…¶ä»–æ–¹æ¡ˆçš„å¯¹æ¯”

### ğŸ“š å¤ä¹ å»ºè®®
1. **ç†è§£è¯»å†™åˆ†ç¦»**ï¼šé‡ç‚¹æŒæ¡åŒ map è®¾è®¡
2. **æŒæ¡å»¶è¿Ÿåˆ é™¤**ï¼šç†è§£åˆ é™¤æœºåˆ¶çš„è®¾è®¡
3. **å®è·µåº”ç”¨**ï¼šå‡†å¤‡å®é™…ä½¿ç”¨æ¡ˆä¾‹
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šç†è§£æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ 